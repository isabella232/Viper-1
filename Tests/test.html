<html>
    <head>
        <title>Running: __TEST_TITLE__</title>
        <style>
        body {
            margin: 50px;
            background-color: #EEE;
            font-size: 20px;
        }

        #content {
            width: 800px;
            height: 600px;
            margin: auto;
            margin-top: 90px;
        }

        #menu {
            position: fixed;
            right: 100px;
            width: 100px;
            top: 50px;
        }

        #testTitle {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #666;
            color: #EEE;
            font-size: 18px;
            text-align: center;
            font-weight: bold;
            padding: 5px 0;
        }

        #windowTarget {
            position: fixed;
            left: 0;
            top: 0;
            z-index: 999999;
        }
        </style>

        <script type="text/javascript" src="../DfxJSLib/dfx.js"></script>
        <script type="text/javascript" src="../Viper-all.js"></script>
        <script type="text/javascript">
            var viper = null;
            dfx.addLoadEvent(function() {
                var contentElement = dfx.getId('content');

                viper = new Viper('test');
                var pluginSets = {
                    all: {
                        plugins: ['ViperCoreStylesPlugin', 'ViperKeyboardEditorPlugin', 'ViperInlineToolbarPlugin', 'ViperHistoryPlugin', 'ViperListPlugin', 'ViperFormatPlugin', 'ViperToolbarPlugin', 'ViperTableEditorPlugin', 'ViperCopyPastePlugin', 'ViperImagePlugin', 'ViperLinkPlugin', 'ViperSearchReplacePlugin', 'ViperAcronymPlugin', 'ViperAbbrPlugin', 'ViperLangPlugin', 'ViperTrackChangesPlugin']
                    }
                };

                viper.setPluginSets(pluginSets);
                viper.getPluginManager().usePluginSet('all');
                viper.setEditableElement(contentElement);

                var jsRes = dfx.getId('jsRes');
                jsRes.value = '';
                dfx.addEvent(jsRes, 'copy', function() {
                    setTimeout(function() {
                        viper.focus();
                    }, 100);
                });

                var jsExec   = dfx.getId('jsExec');
                jsExec.value = '';

                dfx.addEvent(jsExec, 'focus', function(e) {
                    jsExec.value = '';
                });

                // We are not going to use paste() until this Sikuli bug is fixed:
                // https://bugs.launchpad.net/sikuli/+bug/769837
                //dfx.addEvent(jsExec, 'paste', function(e) {
                //        eval(jsExec.value);
                //    }, 100);
                //});
            });

            /**
             * Returns the HTML contents of the specified element.
             */
            function gHtml(selector, index)
            {
                index = index || 0;
                if (selector) {
                    return dfx.getHtml(dfxjQuery(selector)[index]).replace("\n", '');
                } else {
                    return dfx.getHtml(dfx.getId('content')).replace("\n", '');
                }

            }

            /**
             * Executes the JS string set as the value of jsExec textarea.
             */
            function execJS()
            {
                var val = dfx.getId('jsExec').value;
                dfx.getId('jsRes').value  = '';
                dfx.getId('jsExec').value = '';

                val  = 'var jsResult = ' + val + ';';
                val += 'dfx.getId("jsRes").value = dfx.jsonEncode(jsResult);';

                // Execute JS.
                eval(val);

            }

            /**
             * Returns the bounding rectangle values of the specified element.
             */
            function gBRec(selector, index)
            {
                return dfx.getBoundingRectangle(dfxjQuery(selector)[index]);

            }

            /**
             * Returns the specified table's structure.
             */
            function gTS(index, incContent)
            {
                var struct = {
                    rows: []
                };

                var table = dfx.getTag('table')[0];
                var rows  = dfx.getTag('tr', table);
                for (var i = 0; i < rows.length; i++) {
                    var row   = rows[i];
                    var cells = dfx.getTag('td,th', row);

                    var rowInfo = {
                        cells: []
                    };

                    for (var j = 0; j < cells.length; j++) {
                        var cell = cells[j];
                        var cellInfo = {
                            rowspan: cell.getAttribute('rowspan') || 0,
                            colspan: cell.getAttribute('colspan') || 0,
                            heading: dfx.isTag(cell, 'th')
                        };

                        if (incContent) {
                            cellInfo.content = dfx.getHtml(cell);
                        }

                        rowInfo.cells.push(cellInfo);
                    }

                    struct.rows.push(rowInfo);
                }//end for

                return struct;

            }

            /**
             * Inserts a new table.
             */
            function insTable(rows, cols)
            {
                return viper.getPluginManager().getPlugin('ViperTableEditorPlugin').insertTable(rows, cols);

            }

            function gTblBStatus()
            {
                var btns = {
                    splitVert: false,
                    splitHoriz: false,
                    mergeUp: false,
                    mergeDown: false,
                    mergeLeft: false,
                    mergeRight: false
                };

                for (var btn in btns) {
                    if (dfx.hasClass(dfx.getClass(btn)[0], 'disabled') === false){
                        btns[btn] = true;
                    }
                }

                return btns;

            }//end gTblBStatus()


            function gListS(listElem, incContent)
            {
                var list = [];

                listElem = listElem || dfx.getTag('ul,ol', dfx.getId('content'))[0];

                for (var i = 0; i < listElem.childNodes.length; i++) {
                    var node = listElem.childNodes[i];
                    if (dfx.isTag(node, 'li') === true) {
                        var item     = 'li';
                        var subLists = dfx.getTag('ul,ol', node);
                        if (subLists.length > 0) {
                            item = {};
                            item[dfx.getTagName(subLists[0])] = gListS(subLists[0], incContent);
                        }

                        if (incContent) {
                            if (typeof item === 'string') {
                                item = {};
                            }

                            var content = '';
                            for (var child = node.firstChild; child; child = child.nextSibling) {
                                if (dfx.isTag(child, 'ul') === true  || dfx.isTag(child, 'ol') === true) {
                                    break;
                                } else if (child.nodeType === dfx.TEXT_NODE) {
                                    content += child.data;
                                } else {
                                    content += child.outerHTML;
                                }
                            }

                            item.content = content;
                        }//end if

                        list.push(item);
                    }
                }

                return list;

            }

            function gTagCounts(tagNames)
            {
                tagNames = tagNames || '*';
                var tagCounts = {};
                var tags = dfx.getTag(tagNames, dfx.getId('content'));
                for (var i = 0; i < tags.length; i++) {
                    var tagName = dfx.getTagName(tags[i]);
                    if (!tagCounts[tagName]) {
                        tagCounts[tagName] = 1;
                    } else {
                        tagCounts[tagName]++;
                    }
                }

                tagNames = tagNames.split(',');

                for (var i = 0; i < tagNames.length; i++) {
                    if (!tagCounts[tagNames[i]]) {
                        tagCounts[tagNames[i]] = 0;
                    }
                }

                return tagCounts;

            }

        </script>
    </head>
    <body spellcheck="false">
        <img id="windowTarget" src="./Core/Images/window-target.png"/>
        <div id="content">__TEST_CONTENT__</div>
        <div id="menu">
            <textarea id="jsExec" accesskey="J"></textarea>
            <button onclick="execJS()">Exec</button>
            <textarea id="jsRes" accesskey="R"></textarea>
            <div id="testTitle"><em>Running:</em> __TEST_TITLE__</div>
        </div>
    </body>
</html>
